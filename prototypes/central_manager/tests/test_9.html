<html>
<head>
	<script src="./bower_components/jquery/dist/jquery.js"></script>

	<script src="./bower_components/angular/angular.js"></script>
	<script src="./bower_components/angular-sanitize/angular-sanitize.js"></script>
	<script src="./bower_components/angular-bootstrap/ui-bootstrap-tpls.js"></script>
	<link rel="stylesheet" href="./bower_components/bootstrap/dist/css/bootstrap.min.css" >
	<link rel="stylesheet" href="./fonts/font-awesome.css">
	<title>Test 9</title>
	
</head>
	<body ng-app="myapp" ng-controller="MainCtrl">

		<style>


			.test {
				margin: 50px auto;
				width:600px;
			}

			.ms-dropdown {
				position:relative;
				font-size: 13px;
				display: block;
			}

			.ms-select-list {
				display:inline-block;
				border:1px solid #7D7D7D;
				padding:5px 0;
				min-width:195px;
			}

			.dropshadow {
				-webkit-box-shadow: 8px 8px 5px 0px rgba(125, 125, 125 ,1);
				-moz-box-shadow: 8px 8px 5px 0px rgba(125, 125, 125 ,1);
				box-shadow: 8px 8px 5px 0px rgba(125, 125, 125 ,1);
			}

			ul {
				list-style-type: none;
				margin:0;
				padding: 0;
			}

			li {
				margin: 0 0 5px;
			}
			.ms-label {
				font-size: 14px;
				cursor: pointer;
				margin:0;
			}

			.ms-label.active  .status{
				color:red;
			}

			.sort-order {
				display:inline-block;
				margin:10px 0;
				cursor: pointer;
			}

			.sort-order:after {
				font-family: "font awesome";
  				content : '\f0de';
  			}

			.sort-order.reverse:after {
				font-family: "font awesome";
				content: '\f0dd';
			}

			.ms-item {
				text-indent:20px;
			}

			.ms-item.disabled {
				cursor: default;
			}

			.ms-item.disabled:hover {
				cursor: default;
				background-color: inherit;
			}

			.ms-item.disabled .ms-ok {
				visibility: visible;
			}

			.ms-item .ms-ok {
				visibility: hidden;
				display:inline;
			}

			.ms-item:hover {
				cursor: pointer;
				background-color: #BBBBBB;
			}

			.ms-item.selected .ms-ok {
				visibility: visible;
			}

			.ms-holder {
				padding:2px 20px 0 20px;
			}

			.ms-sublabel {
				font-weight:bold;
				text-indent: 10px;
			}
			.divider {
				border-bottom: 1px solid  #7D7D7D;
				margin:0 5px 5px;
			}

			.ms-ok {
				display:inline;
				padding: 0 10px 0 0;
			}	


		</style>
		
		<div class="test">
			<h1>Test 9</h1>

			<div style="width:300px;float:left;"><ms-dropdown selected-sort-index="0" is-active=true msid="column_1"></ms-dropdown></div>
			<div style="width:300px;float:left;"><ms-dropdown selected-sort-index="1" msid="column_2"></ms-dropdown></div>



			<div class="well" style="position:absolute;top:400px;">
				<h4>Sort and Filter</h4>
				<div>Active: {{DropdownService.getActive()}}</div>
				<div>Order By: {{SortAndFilterService.orderBy}}</div>
				<div>Filter By: {{SortAndFilterService.filterBy}}</div>
			</div>
		</div>



		<script type="text/ng-template" id="/tpl.html">
			<div class="ms-dropdown" id="{{id}}">
				<h6 class="ms-label" ng-class='{active: DropdownService.getActive() === id}'><span ng-click="selectSort(selectedItem)" class='status'>{{selectedItem.label}}</span>&nbsp<span ng-click="toggle(id)" class="glyphicon glyphicon-collapse-down"></span></h6>
				<ul class="ms-select-list dropshadow hide">
					<li class="ms-item" ng-repeat="item in items" ng-class="{disabled:item.label === selectedItem.label}" ng-click="selectSort(item)"><span class="glyphicon glyphicon-ok ms-ok"></span>{{item.label}}</li>

					<ul ng-if="selectedItem.filters">
						<li class="divider"></li>
						<li class="ms-sublabel">FILTER</li>

						<li ng-repeat="filter in selectedItem.filters" class="ms-item" ng-click="selectFilter(filter)" ng-class="{selected:selectedFilter === filter}"><span class="glyphicon glyphicon-ok ms-ok"></span>{{filter.label}}</li>

						<li ng-if="selectedItem.template"><ng-include src="selectedItem.template"></ng-include></li>
					</ul>

				</ul>
			</div>
		</script>

		<script  type="text/ng-template" id="/name.html">

			<li class="ms-holder"><input type="text" class="ms-name-input" ng-model="name" placeholder="Enter Name" ng-disabled="enabledOn(selectedFilter)" ng-click="dontPassEvent($event)"/></li>
			<li class="ms-holder"><button class="btn btn-primary ms-apply submit-button"  
			 ng-disabled="name == '' || enabledOn(selectedFilter)" ng-click="submit(name)">apply</button></li>

		</script>
		

		<script>
			angular.module('myapp',['ui.bootstrap', 'ngSanitize'])
			.controller('MainCtrl', function($scope, DropdownService, SortAndFilterService, DropdownService){
				$scope.SortAndFilterService = SortAndFilterService;
				$scope.DropdownService = DropdownService;
			})
		.directive('msDropdown', function($document, $timeout, DROPDOWNITEMS, DropdownService, SortAndFilterService) {
        	return {
            restrict: "AE",
            templateUrl: "/tpl.html",
            replace: true,
            scope: {
                selectedSortIndex: "@",
                isActive: "@",
                id: "@msid"
            },
            controller: function($scope, $element, $attrs) {
            	var dropdown = $($element).find('.ms-select-list'),
                focusInput = function(){
                	var inputField = $element.find('input');
                    if (inputField) {
                    	$timeout(function(){inputField.focus()});
                    }
                },
                close = function(){
                    dropdown.addClass('hide');
                    $document.off('click', close);
                },
                setOrderBy = function(item){
                	SortAndFilterService.orderBy = item.label;
                	DropdownService.setActive($scope.id);
                },
                setFilterBy = function(item, who){
                	SortAndFilterService.filterBy = {};
                	if (isActive() && item){
                		SortAndFilterService.filterBy[item.label] = who;
                	}
                }, 
                setAsActive = function(id) {
                	DropdownService.setActive(id);
                    setOrderBy($scope.selectedItem);
                    setFilterBy($scope.selectedFilter, getName($scope.selectedFilter));
                },
                getName = function(filter){
                	if (filter) {
						return (filter.label.indexOf('by me') > -1) ? $scope.me : $scope.name;
					}
					return "";
                },
                isActive = function (){
                	return $scope.id === DropdownService.getActive();
                },
                dontPassEvent = function(evt){
                	if (evt) {
                        evt.preventDefault();
                        evt.stopPropagation();
                    }
                }

                $scope.dontPassEvent = dontPassEvent;

                $document.on('keypress', function(event){
                	if (event.keyCode == 13 && $scope.isActive && !$scope.enabledOn($scope.selectedFilter)){
                		var menu = DropdownService.getActive(), 
                		submitButton = $("#" + menu + " .submit-button")
                		$timeout(function(){angular.element(submitButton).triggerHandler('click');})
                	}
                })


                $scope.DropdownService = DropdownService;
                $scope.items = DROPDOWNITEMS;

                $scope.selectedItem = DROPDOWNITEMS[$scope.selectedSortIndex]
                $scope.selectedFilter = null;
                $scope.me = "Pete";
                $scope.name = "";

                if ($scope.isActive) {
                	// ***
                	DropdownService.setActive($scope.id);
                	SortAndFilterService.orderBy = $scope.selectedItem.label;
                }

				$scope.enabledOn = function(which) {
					return which ? ((which.label === $scope.selectedItem.enabledOn) ? false : true) : true;
				}


                $scope.submit = function(name) {
                    if (($scope.selectedFilter.label === $scope.selectedItem.enabledOn) && (name === null || name === "")) {
                        alert("Please enter a name to filter");
                        focusInput();
                    } else {
                       $scope.name = name;
                       console.info ("submitted: " + $scope.name);
                       close();

                    	// ***
                    	setFilterBy($scope.selectedFilter, $scope.name);
                    }
                }

                $scope.toggle = function(id) {
                    if (dropdown.hasClass('hide')) {
                        dropdown.removeClass('hide');

                        // ***
                        setAsActive(id);
                        $timeout(function(){$document.on('click', close);});
                    } else {
                        dropdown.addClass('hide');
                        $document.off('click', close);
                    }
                }

                $scope.selectSort = function(item) {
                    $scope.selectedItem = item;

                    // ***
                    setOrderBy(item);
                }

                $scope.selectFilter = function(which) {
                	if (!$scope.enabledOn(which)){
                		$document.off('click', close);
                	}

                	if (!$scope.enabledOn($scope.selectedFilter)) {
                		$document.on('click', close);
                	}

                    $scope.selectedFilter = ($scope.selectedFilter === which) ? "" : which;
                    if (which.label === $scope.selectedItem.enabledOn ){
                    	focusInput();
                    }

                    // ***
                    setFilterBy($scope.selectedFilter, getName($scope.selectedFilter));
                }
            }
        }
    })
	.factory("DropdownService", function(){
		var active; //ID of currently active 

		return {
			getActive: function(){
				return active;
			},
			setActive: function(which){
				active = which;
			}
		}
    }).factory('SortAndFilterService', function() {
        return {
            filterBy: {},
            orderBy: {}
        };
    }).constant('DROPDOWNITEMS', [{
	label:"Last Modified"
	},
	{
		label:"Modified By",
		filters: [{label: 'Modified by me'},{label: 'Modified by:'}],
		template: '/name.html',
		enabledOn: 'Modified by:'
	},
	{
		label:"Type"
	},
	{
		label:"Owner",
		filters: [{label: 'Owned by me'},{label: 'Owned by:'}],
		template: '/name.html',
		enabledOn: 'Owned by:'
	},
	{
		label:"Defaults",
		filters: [{label: 'Show only defaults'}]
	}]);
		</script>
	</body>
</html>